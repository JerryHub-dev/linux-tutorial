# 磁盘配额（Quota）的应用于实践

Quota 字面意思是「限额」，对于磁盘来说就是限制容量的使用

## 什么是 Quota？

就是限制用户对磁盘容量的使用，不至于让其中某一个用户使用了大量的硬盘容量，导致其他用户不够用的情况

### Quota 的一般用途

针对网络服务的设计，比较常用的情况是：

- 针对 www server，如：每个人的网页空间的容量限制
- 针对 mail server，如：每个人的邮件空间限制
- 针对 file server，如：每个人最大的可用网络磁盘空间（教学环境中最常见）

针对 Linux 系统主机上面的使用者有如下常用情况：

- 使用群组限制：限制某一群组所能使用的最大磁盘配额

- 使用用户限制：限制某一用户的最大磁盘配额

- 限制某一目录的最大磁盘配额

  在 EXT 家族文件系统的磁盘配额主要是针对整个文件系统来处理，所以大多针对挂载点进行设计。

  新的 xfs 可以使用 project 模式，可以针对个别的目录（非文件系统）来设计磁盘配额

基本上 qutoa 让管理员知道磁盘使用率以及管理磁盘使用情况的一个工具。比较特别的是 XFS 的 quota 是整合到文件系统内，并不是其他外挂程序来管理的。所以通过 quota 来直接回报磁盘使用率，要比 unix 工具快速。如 `du`会重新计算目录下的磁盘使用率，但 xfs 可以通过 xfs_quota 直接获得各个目录的使用率，速度要快很多

### Quota 的使用限制

- EXT 文件系统家族只能针对整个 filesystem，xfs 可以使用 project 模式来为不同目录磁盘配额

- 核心必须支持 quota

  Linux 核心必须有支持 quota 功能，CentOS7.x 预设支持 quota 功能

- 只对一般身份使用者有效

  root 不能设置 quota，因为整个服务器数据都是他的

- 若启用 SELinux，非所有目录均可设置 quota

  新版 CentOS 预设启用 SELinux 功能，该功能加强了某些细部的权限控制，所以预设情况下，只能针对 `/home/`进行配置 quota

  如果要针对其他目录配置 quota，后续章节会讲解怎么解开 SELinux 限制的方法

不同文件系统 quota 的处理不太一样，在 quota 前，先确认你的文件系统

### Quota 的规范设置项目

针对 XFS filesystem 的限制项目主要分为以下几部分：

- 分别针对用户 user、群组 group、个别目录 project

  quota 的限制中，主要针对以上项进行磁盘使用率的限制

- 容量限制 block 或文件数量 inode 限制

  第 7 章中说到，文件系统主要规划为存放属性的 inode 与实际文件数据的 block 区块。

  - 限制 inode 用量：限制可以建立的 文件数量
  - 限制 block 用量：管理用户磁盘容量限制，较常见该方式

- 柔性 soft 劝导与硬性 hard 规定

  inode 和 block 限制值有两个：soft 与 hard，通常 hard 值比 soft 高。

  如：限制项目为 block，可以限制 hard 为 500MBytes ，soft 为 400MBytes。

  - hard：表示使用者绝对不会超过该值。
  - soft：表示使用者在地狱 soft 限制时，可以正常使用磁盘，但若超过 soft 且低于 hard 值，每次用户登录系统时，系统会主动发出磁盘即将爆满的警告信息，且会给予一个宽限时间（grace time），如果在宽限时间内降低到了 soft 限制下，则宽限时间会停止

- 会倒计时的宽限时间（grace time）

  只有用户的磁盘用量介于 soft 到 hard 之间时，才会出现倒计时，由于达到 hard 值时，用户的磁盘使用权可能会被锁住。为了担心用户没有注意到磁盘配额问题，因此涉及了 soft，相当于预警机制，一般预设的宽限时间为 7 天，**如果 7 天内你还不进行容量降低动作，那么 soft 限制会立刻取代 hard 值来做为 quota 的限制**

## 一个 XFS 文件系统的 Quota 实验