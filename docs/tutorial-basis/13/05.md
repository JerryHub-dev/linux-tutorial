# 用户的特殊 shell 与 PAM 模块

前面讲解的大多是一般身份用户与系统管理员 root 的相关操作，而且大多是关于可登陆系统的账户来说的。

那么想要建立一个 **仅仅能使用 mail server 相关邮件服务的账户，而该账户并不能登陆 Linux 主机**，如果分配密码则

另外 前面说`/etc/login.defs`文件中，关于密码长度默认是 5 个字符串长度，但是该值以及被 PAM 模块所取代了，那么 PAM 是什么？为什么他可以影响我们使用者的登录呢？

## 特殊的 shell：`/sbin/nologin`

在 passwd 文件结构里面有看到过这个 shell 的配置，如果配置了这个 shell 给一个账户，那么该账户试图登录的时候，就会提示如下的信息

```bash
This account is currently not available
```

这里说的无法登录仅表示：这个使用者无法使用 bash 或其他 shell 来登录系统，并不是说无法使用其他系统资源

那么上面的提示内容，仅仅提示该账户目前不可用，其实可以通过 `/etc/nologin.txt` 文件来自定义提示内容

```bash
# 利用纯 mail 账户，例如 myuser3 时，显示自定义内容给登陆者查看

[root@study ~]# vim /etc/nologin.txt
 该账户只用来接收邮件，不提供登录服务。

# 之前创建 myuser3 的时候 shell 就设置的是 /sbin/nologin
[pro2@study ~]$ su -l myuser3
Password: 
该账户只用来接收邮件，不提供登录服务。

# 可以看到提示信息就被自定义了
```

## PAM 模块简介

PAM（Pluggable Authentication Modules 嵌入式模块）可以说是一套应用程序编程接口，提供了许多验证机制，只要使用者将验证阶段的需求告知 PAM 后，PAM 就能返回验证结果成功或失败。

没有用 PAM 之前，需要自己写程序处理账户密码的验证，那么就有人收集了很多验证需求实现后提供了一个验证模块。因此程序都可以引用该模块来进行验证

![image-20200225155547026](./assets/image-20200225155547026.png)

如图示，PAM 是一个独立的 API，你的程序也可以引入他来进行验证

PAM 用来进行验证的数据成为模块（Modules），每个 PAM 模块功能都不太相同，比如，之前 passwd 指令输入密码，报错提示在字典上面找到的字符串，这是 PAM 的 pam_cracklib.so 模块的功能

## PAM 模块设置语法

这里以  passwd 指令调用的 PAM 来说明：

1. 用户开始执行 `/usr/bin/passwd` 程序，并输入密码
2. passwd 调用 PAM 模块进行验证
3. PAM 模块会到 `/etc/pam.d/` 寻找与指令 passwd 同名的配置文件
4. 根据 `/etc/pam.d/passwd` 内的设置，引用相关的 PAM 模块逐步进行验证分析；

那么从这里就看出来了，他的入口配置是：

1. 配置文件要放到 `/etc/pam.d/` 中，且同名
2. 程序要调用

下面先来看看配置文件的内容。

```bash
[pro2@study ~]$ cat /etc/pam.d/passwd 
#%PAM-1.0		# PAM 版本说明
auth       include	system-auth			# 每一行是一个验证程序
account    include	system-auth
password   substack	system-auth
-password   optional	pam_gnome_keyring.so use_authtok
password   substack	postlogin
验证类别	控制标准	PAM 模块与该模块的参数
```

该文件中，除了第一行声明  PAM 版本外，其他的 `#` 开头的均为批注内容

上面第 2 字段中出现的 include 是标识，调用后面的文件来作为这个类别的验证，所以是调用 `/etc/pam.d/system-auth` 文件来进行验证

1. 验证类别（type）：主要分为 4 种

   - auth：authentication 认证

     主要用来校验使用者的身份验证，这种类别通常是需要密码来校验的，所以后续接的模块是用来校验用户的身份

   - account：account 账户

     大部分是在进行 authorization 授权，这种类别主要检验使用者是否具有正确的权限，比如：使用一个过期的密码来登录，就无法登录了

   - session

     该使用者在此次登录（或使用这个指令）期间，PAM 所给予的环境设置。这个类别通常用在记录用户登录与注销时的信息。

     例如：假如你常常使用 su 或 sudo 指令，那么应该可以在 `/var/log/secure` 里面发现很多关于 pam 的说明，而且记载的数据是`session open、session close` 的信息

   - password 密码

     主要提供验证的修改工作，比如修改密码

   这 4 个验证类型通常是有顺序的（也有例外），有顺序是因为：

   1. 总是要先验证身份（auth）后
   2. 系统才能够获取到用户身份给予适当的授权与权限设置（account）
   3. 登录与注销期间的环境才需要设置，需要记录登录与注销信息 （session）
   4. 修改密码时，使用 password 类别

   根据业务来看，貌似是有必要有顺序的

2. 验证的控制旗标（control flag）

   